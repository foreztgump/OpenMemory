version: '3.8'
services:
  openmemory:
    build:
      context: ./packages/openmemory-js
      dockerfile: Dockerfile
    ports:
      - '8080:8080'
    environment:
      # Core
      - OM_PORT=${OM_PORT:-8080}
      - OM_MODE=${OM_MODE:-standard}
      - OM_TIER=${OM_TIER:?}
      - OM_DB_PATH=${OM_DB_PATH:-/data/openmemory.sqlite}
      - OM_API_KEY=${OM_API_KEY:?}
      - OM_TELEMETRY=${OM_TELEMETRY:-false}
      # Rate Limiting
      - OM_RATE_LIMIT_ENABLED=${OM_RATE_LIMIT_ENABLED:-true}
      - OM_RATE_LIMIT_WINDOW_MS=${OM_RATE_LIMIT_WINDOW_MS:-60000}
      - OM_RATE_LIMIT_MAX_REQUESTS=${OM_RATE_LIMIT_MAX_REQUESTS:-100}
      # Embeddings â€” Voyage AI via OpenAI-compatible endpoint
      - OM_EMBEDDINGS=${OM_EMBEDDINGS:-openai}
      - OM_EMBEDDING_FALLBACK=${OM_EMBEDDING_FALLBACK:-synthetic}
      - OM_EMBED_MODE=${OM_EMBED_MODE:-simple}
      - OM_VEC_DIM=${OM_VEC_DIM:-1024}
      - OPENAI_API_KEY=${OPENAI_API_KEY:?}
      - OM_OPENAI_BASE_URL=${OM_OPENAI_BASE_URL:?}
      - OM_OPENAI_MODEL=${OM_OPENAI_MODEL:-voyage-code-3}
      # Metadata & Vector Backend
      - OM_METADATA_BACKEND=${OM_METADATA_BACKEND:-sqlite}
      - OM_VECTOR_BACKEND=${OM_VECTOR_BACKEND:-sqlite}
      - OM_VECTOR_TABLE=${OM_VECTOR_TABLE:-openmemory_vectors}
      # Auto Reflection
      - OM_AUTO_REFLECT=${OM_AUTO_REFLECT:-true}
      - OM_REFLECT_INTERVAL=${OM_REFLECT_INTERVAL:-10}
      - OM_REFLECT_MIN_MEMORIES=${OM_REFLECT_MIN_MEMORIES:-20}
      # User Summaries
      - OM_USER_SUMMARY_INTERVAL=${OM_USER_SUMMARY_INTERVAL:-30}
      - OM_USE_SUMMARY_ONLY=${OM_USE_SUMMARY_ONLY:-true}
      - OM_SUMMARY_MAX_LENGTH=${OM_SUMMARY_MAX_LENGTH:-200}
      # HSG
      - OM_SEG_SIZE=${OM_SEG_SIZE:-10000}
      - OM_CACHE_SEGMENTS=${OM_CACHE_SEGMENTS:-3}
      - OM_MAX_ACTIVE=${OM_MAX_ACTIVE:-64}
      # Decay
      - OM_DECAY_LAMBDA=${OM_DECAY_LAMBDA:-0.02}
      - OM_DECAY_INTERVAL_MINUTES=${OM_DECAY_INTERVAL_MINUTES:-1440}
      - OM_DECAY_RATIO=${OM_DECAY_RATIO:-0.03}
      - OM_DECAY_SLEEP_MS=${OM_DECAY_SLEEP_MS:-200}
      - OM_DECAY_THREADS=${OM_DECAY_THREADS:-3}
      - OM_DECAY_COLD_THRESHOLD=${OM_DECAY_COLD_THRESHOLD:-0.25}
      - OM_DECAY_REINFORCE_ON_QUERY=${OM_DECAY_REINFORCE_ON_QUERY:-true}
      # Compression & Regeneration
      - OM_REGENERATION_ENABLED=${OM_REGENERATION_ENABLED:-true}
      - OM_MAX_VECTOR_DIM=${OM_MAX_VECTOR_DIM:-256}
      - OM_MIN_VECTOR_DIM=${OM_MIN_VECTOR_DIM:-64}
      - OM_SUMMARY_LAYERS=${OM_SUMMARY_LAYERS:-3}
    volumes:
      - openmemory_data:/data
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  openmemory_data:
    driver: local